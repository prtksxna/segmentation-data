{"version":3,"file":"bar.js","sourceRoot":"","sources":["../../../../src/compile/mark/bar.ts"],"names":[],"mappings":"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","sourcesContent":["import {isNumber} from 'vega-util';\nimport {isBinned, isBinning} from '../../bin';\nimport {X, Y} from '../../channel';\nimport {Config} from '../../config';\nimport {isFieldDef} from '../../fielddef';\nimport * as log from '../../log';\nimport {MarkDef} from '../../mark';\nimport {hasDiscreteDomain, ScaleType} from '../../scale';\nimport {getFirstDefined} from '../../util';\nimport {isVgRangeStep, VgEncodeEntry, VgValueRef} from '../../vega.schema';\nimport {getMarkConfig} from '../common';\nimport {ScaleComponent} from '../scale/component';\nimport {UnitModel} from '../unit';\nimport {MarkCompiler} from './base';\nimport * as mixins from './mixins';\nimport * as ref from './valueref';\n\nexport const bar: MarkCompiler = {\n  vgMark: 'rect',\n  encodeEntry: (model: UnitModel) => {\n    return {\n      ...mixins.baseEncodeEntry(model, {size: 'ignore', orient: 'ignore'}),\n      ...x(model),\n      ...y(model)\n    };\n  }\n};\n\nfunction x(model: UnitModel): VgEncodeEntry {\n  const {config, encoding, markDef, width} = model;\n  const orient = markDef.orient;\n  const sizeDef = encoding.size;\n\n  const xDef = encoding.x;\n  const x2Def = encoding.x2;\n  const xScaleName = model.scaleName(X);\n  const xScale = model.getScaleComponent(X);\n  // x, x2, and width -- we must specify two of these in all conditions\n  if (isFieldDef(xDef) && isBinned(xDef.bin)) {\n    return mixins.binPosition(\n      xDef,\n      x2Def,\n      X,\n      xScaleName,\n      getFirstDefined(markDef.binSpacing, config.bar.binSpacing),\n      xScale.get('reverse')\n    );\n  } else if (orient === 'horizontal' || x2Def) {\n    return {\n      ...mixins.pointPosition('x', model, 'zeroOrMin'),\n      ...mixins.pointPosition2(model, 'zeroOrMin', 'x2')\n    };\n  } else {\n    // vertical\n    if (isFieldDef(xDef)) {\n      const xScaleType = xScale.get('type');\n      if (isBinning(xDef.bin) && !sizeDef && !hasDiscreteDomain(xScaleType)) {\n        return mixins.binPosition(\n          xDef,\n          undefined,\n          X,\n          model.scaleName('x'),\n          getFirstDefined(markDef.binSpacing, config.bar.binSpacing),\n          xScale.get('reverse')\n        );\n      } else {\n        if (xScaleType === ScaleType.BAND) {\n          return mixins.bandPosition(xDef, 'x', model);\n        }\n      }\n    }\n    // sized bin, normal point-ordinal axis, quantitative x-axis, or no x\n\n    return mixins.centeredBandPosition(\n      'x',\n      model,\n      {...ref.mid(width)},\n      defaultSizeRef(markDef, xScaleName, xScale, config)\n    );\n  }\n}\n\nfunction y(model: UnitModel) {\n  const {config, encoding, height, markDef} = model;\n  const orient = markDef.orient;\n  const sizeDef = encoding.size;\n\n  const yDef = encoding.y;\n  const y2Def = encoding.y2;\n  const yScaleName = model.scaleName(Y);\n  const yScale = model.getScaleComponent(Y);\n\n  // y, y2 & height -- we must specify two of these in all conditions\n  if (isFieldDef(yDef) && isBinned(yDef.bin)) {\n    return mixins.binPosition(\n      yDef,\n      y2Def,\n      Y,\n      yScaleName,\n      getFirstDefined(markDef.binSpacing, config.bar.binSpacing),\n      yScale.get('reverse')\n    );\n  } else if (orient === 'vertical' || y2Def) {\n    return {\n      ...mixins.pointPosition('y', model, 'zeroOrMin'),\n      ...mixins.pointPosition2(model, 'zeroOrMin', 'y2')\n    };\n  } else {\n    if (isFieldDef(yDef)) {\n      const yScaleType = yScale.get('type');\n      if (isBinning(yDef.bin) && !sizeDef && !hasDiscreteDomain(yScaleType)) {\n        return mixins.binPosition(\n          yDef,\n          undefined,\n          Y,\n          model.scaleName('y'),\n          getFirstDefined(markDef.binSpacing, config.bar.binSpacing),\n          yScale.get('reverse')\n        );\n      } else if (yScaleType === ScaleType.BAND) {\n        return mixins.bandPosition(yDef, 'y', model);\n      }\n    }\n    return mixins.centeredBandPosition(\n      'y',\n      model,\n      ref.mid(height),\n      defaultSizeRef(markDef, yScaleName, yScale, config)\n    );\n  }\n}\n\nfunction defaultSizeRef(markDef: MarkDef, scaleName: string, scale: ScaleComponent, config: Config): VgValueRef {\n  if (markDef.size !== undefined) {\n    return {value: markDef.size};\n  }\n  const sizeConfig = getMarkConfig('size', markDef, config, {\n    // config.mark.size shouldn't affect bar size\n    skipGeneralMarkConfig: true\n  });\n\n  if (sizeConfig !== undefined) {\n    return {value: sizeConfig};\n  }\n\n  if (scale) {\n    const scaleType = scale.get('type');\n    if (scaleType === 'point' || scaleType === 'band') {\n      if (config.bar.discreteBandSize !== undefined) {\n        return {value: config.bar.discreteBandSize};\n      }\n      if (scaleType === ScaleType.POINT) {\n        const scaleRange = scale.get('range');\n        if (isVgRangeStep(scaleRange) && isNumber(scaleRange.step)) {\n          return {value: scaleRange.step - 1};\n        }\n        log.warn(log.message.BAR_WITH_POINT_SCALE_AND_RANGESTEP_NULL);\n      } else {\n        // BAND\n        return ref.bandRef(scaleName);\n      }\n    } else {\n      // continuous scale\n      return {value: config.bar.continuousBandSize};\n    }\n  }\n  // No Scale\n  const value = getFirstDefined(\n    // No scale is like discrete bar (with one item)\n    config.bar.discreteBandSize,\n    config.scale.rangeStep ? config.scale.rangeStep - 1 : undefined,\n    // If somehow default rangeStep is set to null or undefined, use 20 as back up\n    20\n  );\n  return {value};\n}\n"]}